<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - sTIC d'Opos</title>

  <link rel="icon" type="image/png" sizes="16x16" href="images/icons/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="images/icons/favicon-32x32.png">
  <link rel="icon" href="images/icons/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" sizes="180x180" href="images/icons/apple-touch-icon.png">
  <link rel="manifest" href="images/icons/site.webmanifest">
  <link rel="icon" type="image/png" sizes="192x192" href="images/icons/android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="images/icons/android-chrome-512x512.png">

  <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; background: #0b1020; color: #e7ecff; margin: 0; padding: 20px; }
    h1 { text-align: center; color: #6ae0a7; }
    .container { max-width: 400px; margin: 60px auto; background: #141a2a; border-radius: 16px; padding: 32px 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; }
    label { display: block; margin-bottom: 10px; font-size: 1.1rem; color: #9fb0ff; }
    input[type="text"] { width: 90%; padding: 12px; border-radius: 8px; border: 1px solid #27304a; background: #0b1020; color: #e7ecff; font-size: 1.1rem; margin-bottom: 18px; }
    button { width: 100%; background: linear-gradient(180deg,#2aebad,#21c08d); color: #032217; font-weight: bold; font-size: 1.1rem; padding: 12px; border-radius: 12px; border: none; cursor: pointer; transition: background 0.2s; }
    button:hover { background: linear-gradient(180deg,#21c08d,#2aebad); }
    .msg { color: #ff6b6b; margin-bottom: 10px; font-size: 1rem; }
  </style>
</head>
<body>
  <h1 id="headerTitle">...</h1>
  <div class="container">
    <form id="loginForm" autocomplete="off">
  <label for="username">Introduce tu nombre:</label>
  <input type="text" id="username" name="username" maxlength="32" required autofocus />
  <label for="password" style="margin-top:10px;">Contraseña:</label>
  <input type="password" id="password" name="password" maxlength="32" required style="width: 90%; padding: 12px; border-radius: 8px; border: 1px solid #27304a; background: #0b1020; color: #e7ecff; font-size: 1.1rem; margin-bottom: 18px;" />
  <span style="position:relative; display:inline-block; width:24px; vertical-align:middle; margin-left:-32px; cursor:pointer;" onclick="togglePasswordVisibility()">
    <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color:#9fb0ff;">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
    </svg>
  </span>
  <script>
    // Cargar headerTitle dinámicamente desde config.json
    fetch('assets/config.json')
      .then(r => r.json())
      .then(cfg => {
        if (cfg.headerTitle) {
          document.getElementById('headerTitle').textContent = cfg.headerTitle;
        }
      });

    // Login automático si ya hay user/pass y no relogin=1
    document.addEventListener('DOMContentLoaded', function() {
      const params = new URLSearchParams(window.location.search);
      const relogin = params.get('relogin');
      const user = localStorage.getItem('oposTest_user');
      const pass = localStorage.getItem('user_pass');
      if (user && pass && relogin !== '1') {
        // Simular login automático rellenando y enviando el formulario
        document.getElementById('username').value = user;
        document.getElementById('password').value = pass;
        setTimeout(() => {
          document.getElementById('loginForm').dispatchEvent(new Event('submit', {cancelable: true, bubbles: true}));
        }, 100);
      }
    });

    function togglePasswordVisibility() {
      const pwd = document.getElementById('password');
      const eye = document.getElementById('eyeIcon');
      if (pwd.type === 'password') {
        pwd.type = 'text';
        eye.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7a9.956 9.956 0 012.293-3.95m3.249-2.608A9.956 9.956 0 0112 5c4.478 0 8.268 2.943 9.542 7a9.965 9.965 0 01-4.293 5.032M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3l18 18" />';
      } else {
        pwd.type = 'password';
        eye.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />';
      }
    }
  </script>
  <div class="msg" id="msg"></div>
  <button type="submit">Entrar</button>
    </form>
  </div>
  <script>
  document.getElementById('loginForm').onsubmit = async function(e) {
      e.preventDefault();
      const name = document.getElementById('username').value.trim();
      const pass = document.getElementById('password').value;
      const msgDiv = document.getElementById('msg');
      msgDiv.textContent = '';
      if (!name) {
        msgDiv.textContent = 'Por favor, introduce tu nombre.';
        return;
      }
      if (!pass) {
        msgDiv.textContent = 'Por favor, introduce la contraseña.';
        return;
      }
      msgDiv.textContent = 'Comprobando credenciales...';
      try {
        // Leer API config y buscar usuario remoto, si falla usar users.json local
        let user = null;
        if (false) { // Cambiar a true para usar API remota
          try {
            const config = await fetch('assets/API_config.json').then(r => r.json());
            const APIKEY = config.API_KEY;
            const BASE_URL = config.BASE_URL.replace(/\/?$/, '');
            const url = `${BASE_URL}/opos-usuaris?q={"username":"${name}"}`;
            const res = await fetch(url, {
            headers: {
              'x-apikey': APIKEY
            }
          });
          if (res.ok) {
            const data = await res.json();
            if (data.length) user = data[0];
          }
          } catch (e) {
            // Ignorar error, intentaremos local
          }
        }
        
        if (!user) {
          // Buscar en users.json local
          try {
            const usersData = await fetch('assets/users.json').then(r => r.json());
            if (usersData && Array.isArray(usersData.users)) {
              user = usersData.users.find(u => u.name === name);
            }
          } catch (e) {
            msgDiv.textContent = 'Error accediendo a usuarios locales.';
            return;
          }
        }
        if (!user) {
          msgDiv.textContent = 'Usuario no encontrado.';
          return;
        }
        // Comprobar password con bcryptjs (asegura compatibilidad con window.bcryptjs o window.bcrypt)
        var bcrypt = window.dcodeIO && window.dcodeIO.bcrypt ? window.dcodeIO.bcrypt : (window.bcryptjs || window.bcrypt);
        if (bcrypt) {
          // Mostrar la contraseña introducida encriptada (hash nuevo, no coincide con el guardado)
          const salt = bcrypt.genSaltSync(10);
          const hash = bcrypt.hashSync(pass, salt);
          console.info('Hash de la contraseña introducida:', hash);
        }
        if (bcrypt && bcrypt.compareSync(pass, user.password_hash)) {
          localStorage.setItem('oposTest_user', name);
          if (user._id) {
            localStorage.setItem('user_id', user._id);
          }
          else if (user.guid) {
            localStorage.setItem('user_guid', user.guid);
            localStorage.setItem('user_pass', pass);
          }
          else {
            msgDiv.textContent = 'Id de usuario no encontrado.';
            return;
          }
          window.location.href = 'menu.html';
        } else {
          msgDiv.textContent = 'Contraseña incorrecta.';
        }
      } catch (err) {
        msgDiv.textContent = 'Error: ' + err.message;
      }
    };
  </script>
</body>
  <footer id="footerVersion" style="text-align:center;color:#9fb0ff;font-size:0.98rem;margin-top:40px;opacity:0.7;"></footer>
  <script>
    // Mostrar versión y fecha de última modificación de config.json
    let footerText = '';
    fetch('assets/config.json')
      .then(r => r.json())
      .then(cfg => {
        if (cfg.appVersion) {
          footerText = 'Versió: ' + cfg.appVersion;
        }
      });
    // Obtener fecha de última modificación usando HEAD
    fetch('assets/config.json', { method: 'HEAD' })
      .then(res => {
        const lastMod = res.headers.get('Last-Modified');
        if (lastMod) {
          // Solo la fecha (sin hora)
          const dateStr = new Date(lastMod).toLocaleDateString('ca-ES');
          setTimeout(() => {
            document.getElementById('footerVersion').textContent =
              footerText + (footerText ? ' · ' : '') + dateStr;
          }, 100);
        } else {
          setTimeout(() => {
            document.getElementById('footerVersion').textContent = footerText;
          }, 100);
        }
      });
  </script>
</html>
