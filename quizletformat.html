<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JSON ‚Üí Quizlet (Formatador de tests)</title>
  <style>
    :root { --bg:#0b1020; --card:#141a2a; --ink:#e7ecff; --muted:#9fb0ff; --accent:#6ae0a7; --warn:#ffb86b; --bad:#ff6b6b; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:linear-gradient(160deg,#0b1020,#121a33 35%,#0b1020);color:var(--ink)}
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    header{display:flex;align-items:center;gap:14px;margin-bottom:18px}
    header h1{font-size:clamp(20px,4vw,28px);margin:0}
    header .tag{background:var(--card);border:1px solid #27304a;padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    .card{background:var(--card);border:1px solid #27304a;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .card h2{font-size:16px;margin:0 0 10px;color:var(--muted)}
    textarea{width:100%;min-height:220px;background:#0f1526;border:1px solid #27304a;border-radius:12px;color:var(--ink);padding:12px;line-height:1.45;font-size:14px;resize:vertical}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:10px 0}
    .controls label{display:flex;gap:8px;align-items:center;background:#0f1526;border:1px solid #27304a;padding:8px 10px;border-radius:10px;color:var(--muted);font-size:13px}
    input[type="text"], input[type="number"]{background:#0f1526;border:1px solid #27304a;border-radius:8px;color:var(--ink);padding:8px 10px;min-width:160px}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
    button{background:linear-gradient(180deg,#2aebad,#21c08d);border:none;color:#032217;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    button.secondary{background:#19213a;color:var(--ink);border:1px solid #27304a}
    button.warn{background:linear-gradient(180deg,#ffd27a,#ffb86b);color:#3a2300}
    .meta{display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:12px;margin-top:8px}
    .footer{margin-top:18px;color:var(--muted);font-size:12px}
    .ok{color:var(--accent)} .bad{color:var(--bad)} .mono{font-family:ui-monospace,Consolas,Menlo,monospace}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>JSON ‚Üí Quizlet ¬∑ Formatador de tests</h1>
      <div class="tag">OPOS 24</div>
    </header>

    <div class="grid">
      <section class="card">
        <h2>1) Carrega o enganxa el teu JSON</h2>
        <div class="small">Format esperat: {"nivell":"F√†cil üü¢","pregunta":"...","resposta_correcta":"...","respostes_incorrectes":["...","...","..."],"context":"..."}</div>
        <input type="file" id="fileInput" accept=".json" />
        <textarea id="input" placeholder='Enganxa aqu√≠ el contingut JSON si no carregues fitxer'></textarea>

        <div class="controls">
          <label><input type="checkbox" id="shuffle" checked> Barreja opcions (A-D)</label>
          <label><input type="checkbox" id="pattern"> Rotaci√≥ fixa A‚ÜíB‚ÜíC‚ÜíD (ignora aleatori)</label>
          <label>Seed opcional: <input type="text" id="seed" placeholder="per ex. tema56-bloc1"/></label>
          <label><input type="checkbox" id="balance"> Equilibrar A/B/C/D (experimental)</label>
        </div>

        <div class="btns">
          <button id="convert">Convertir a format Quizlet</button>
          <button id="copy" class="secondary">Copiar resultat</button>
          <button id="download" class="secondary">Descarregar .txt</button>
          <button id="clear" class="warn">Netejar</button>
        </div>
        <div id="status" class="meta"></div>
      </section>

      <section class="card">
        <h2>2) Resultat (llest per a Quizlet)</h2>
        <textarea id="output" readonly placeholder="Aqu√≠ apareixer√† el text final‚Ä¶"></textarea>
        <div class="footer">Format: nivell ‚Üí pregunta ‚Üí opcions A-D ‚Üí ‚≠ê lletra i literal ‚Üí üëâ context ‚Üí <span class="mono">@@@</span></div>
      </section>
    </div>
  </div>

  <script>
    // --- Comprobaci√≥n de usuario con bcryptjs ---
    async function checkUserAuth() {
      const user_guid = localStorage.getItem('user_guid');
      const user_pass = localStorage.getItem('user_pass');
      if (!user_guid || !user_pass) {
        window.location.href = 'index.html';
        return;
      }
      try {
        // Buscar usuario en users.json
        const usersData = await fetch('assets/users.json').then(r => r.json());
        if (!usersData || !Array.isArray(usersData.users)) throw new Error('No users');
        const user = usersData.users.find(u => u.guid === user_guid);
        if (!user) throw new Error('No user');
        // Esperar a que bcryptjs est√© disponible
        function waitForBcrypt() {
          return new Promise(resolve => {
            (function check() {
              if (window.dcodeIO && window.dcodeIO.bcrypt) resolve(window.dcodeIO.bcrypt);
              else if (window.bcryptjs) resolve(window.bcryptjs);
              else if (window.bcrypt) resolve(window.bcrypt);
              else setTimeout(check, 50);
            })();
          });
        }
        const bcrypt = await waitForBcrypt();
        if (!bcrypt.compareSync(user_pass, user.password_hash)) throw new Error('Bad pass');
      } catch (e) {
        window.location.href = 'index.html';
      }
    }
    // Ejecutar al cargar
    document.addEventListener('DOMContentLoaded', checkUserAuth, {once:true});
    function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
    function xhash(str){let h=2166136261>>>0;for(let i=0;i<str.length;i++){h^=str.charCodeAt(i);h=Math.imul(h,16777619)}return h>>>0}
    function shuffleInPlace(arr, rng){for(let i=arr.length-1;i>0;i--){const j=Math.floor((rng?rng():Math.random())*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}} 

    function toQuizlet(items,{doShuffle=true, seed='', balance=false, pattern=false}={}){
      const rng = seed ? mulberry32(xhash(seed)) : null;
      let counts = {A:0,B:0,C:0,D:0};
      const letters=['A','B','C','D'];
      const out=[]; let errors=[];
      let nextPatternIndex = 0;

      items.forEach((q,idx)=>{
        if(!q || typeof q!== 'object'){errors.push(`#${idx+1}: element inv√†lid`);return}
        const {nivell,pregunta,resposta_correcta,respostes_incorrectes,context} = q;
        if(!pregunta || !resposta_correcta || !Array.isArray(respostes_incorrectes)){
          errors.push(`#${idx+1}: camps requerits buits`);return}

        const wrong = respostes_incorrectes.slice(0,3);
        let options = [resposta_correcta, ...wrong];
        if(doShuffle && !pattern){shuffleInPlace(options, rng);}

        let correctIdx;
        if(pattern){ correctIdx = nextPatternIndex % 4; nextPatternIndex++; }
        else{ correctIdx = options.indexOf(resposta_correcta); }

        if(pattern){
          const correctAns = resposta_correcta;
          shuffleInPlace(options, rng);
          options.splice(options.indexOf(correctAns),1);
          options.splice(correctIdx,0,correctAns);
        }

        const correctLetter = letters[correctIdx];
        counts[correctLetter]++;
        const block = [
          `[${nivell||'Sense nivell'}]`,
          `${pregunta}`,
          `A) ${options[0]}`,
          `B) ${options[1]}`,
          `C) ${options[2]}`,
          `D) ${options[3]}`,
          `‚≠ê ${correctLetter}) ${resposta_correcta}`,
          `üëâ ${context||''}@@@`
        ].join('\n');
        out.push(block);
      });

      const txt = out.join('\n\n---\n\n');
      return {txt, counts, errors};
    }

    const $ = sel => document.querySelector(sel);
    const input = $('#input');
    const output = $('#output');
    const status = $('#status');

    document.getElementById('fileInput').addEventListener('change',function(e){
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = evt => { input.value = evt.target.result; };
      reader.readAsText(file);
    });

    $('#convert').addEventListener('click',()=>{
      let data;
      try{ data = JSON.parse(input.value.trim()); }
      catch(e){ output.value=''; status.innerHTML=`<span class="bad">‚ùå JSON inv√†lid:</span> ${e.message}`; return; }
      const res = toQuizlet(data, { doShuffle: $('#shuffle').checked, seed: $('#seed').value.trim(), balance: $('#balance').checked, pattern: $('#pattern').checked });
      output.value = res.txt;
      const {A,B,C,D} = res.counts;
      const err = res.errors.length ? ` ¬∑ <span class="bad">${res.errors.length} errors</span>` : '';
      status.innerHTML = `<span class="ok">‚úîÔ∏è Convertit</span> ¬∑ Distribuci√≥ ‚Üí A:${A} B:${B} C:${C} D:${D}${err}`;
    });

    $('#copy').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(output.value); status.innerHTML = `<span class="ok">üìã Copiat al porta-retalls</span>`; }catch{ status.innerHTML = `<span class="bad">‚ùå No s'ha pogut copiar</span>`; }
    });

    $('#download').addEventListener('click',()=>{
      const blob = new Blob([output.value], {type:'text/plain'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'quizlet.txt';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    $('#clear').addEventListener('click',()=>{ input.value=''; output.value=''; status.textContent=''; document.getElementById('fileInput').value=''; });
  </script>
</body>
</html>