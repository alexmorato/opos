<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Conversor de texto escapado a JSON</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 2rem;
      background: #f6f8fa;
      color: #222;
    }
    h1 { color: #333; }
    textarea {
      width: 100%;
      height: 120px;
      padding: 10px;
      font-family: monospace;
      border: 1px solid #ccc;
      border-radius: 6px;
      resize: vertical;
      background: #fff;
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      background: #0077cc;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: #005fa3; }
    pre {
      background: #fff;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ddd;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    .buttons {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #status {
      font-size: 0.9em;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>üß© Conversor de texto escapado a JSON</h1>
  <div style="margin-bottom:18px;">
    <label for="temaSelect"><b>Tema:</b></label>
    <select id="temaSelect" style="min-width:220px;"></select>
  </div>
  <div style="margin-bottom:1px;">
    <label>
      <input type="checkbox" id="flashcardsCheckbox"> Flashcards
    </label>
  </div>
  <p>Pega aqu√≠ el texto crudo del response (con <code>\\n</code>, <code>\\u0026quot;</code>, etc.):</p>
  <textarea id="input"></textarea>
  <div class="buttons">
  <button id="convertBtn">Convertir a JSON</button>
  <button id="copyBtn">üìã Copiar JSON</button>
  <button id="downloadBtn">üìÅ Descargar fichero .json</button>
  <button id="saveBtn">üíæ API</button>
  <span id="status"></span>
  </div>
  <h2>Resultado:</h2>
  <pre id="output"></pre>

  <script>
    // --- Comprobaci√≥n de usuario con bcryptjs ---
    async function checkUserAuth() {
      const user_guid = localStorage.getItem('user_guid');
      const user_pass = localStorage.getItem('user_pass');
      if (!user_guid || !user_pass) {
        window.location.href = 'index.html';
        return;
      }
      try {
        // Buscar usuario en users.json
        const usersData = await fetch('assets/users.json').then(r => r.json());
        if (!usersData || !Array.isArray(usersData.users)) throw new Error('No users');
        const user = usersData.users.find(u => u.guid === user_guid);
        if (!user) throw new Error('No user');
        // Esperar a que bcryptjs est√© disponible
        function waitForBcrypt() {
          return new Promise(resolve => {
            (function check() {
              if (window.dcodeIO && window.dcodeIO.bcrypt) resolve(window.dcodeIO.bcrypt);
              else if (window.bcryptjs) resolve(window.bcryptjs);
              else if (window.bcrypt) resolve(window.bcrypt);
              else setTimeout(check, 50);
            })();
          });
        }
        const bcrypt = await waitForBcrypt();
        if (!bcrypt.compareSync(user_pass, user.password_hash)) throw new Error('Bad pass');
      } catch (e) {
        window.location.href = 'index.html';
      }
    }
    // Ejecutar al cargar
    document.addEventListener('DOMContentLoaded', checkUserAuth, {once:true});
    // Utilidad para obtener el a√±o actual
    function getCurrentYear() {
      return new Date().getFullYear();
    }

    // Guardar en DB: popup de confirmaci√≥n
    document.getElementById('saveBtn').addEventListener('click', function() {
      const temaSel = document.getElementById('temaSelect');
      const tema = temaSel ? temaSel.value : '';
      let jsonData;
      try {
        jsonData = JSON.parse(document.getElementById('output').textContent);
      } catch (e) {
        alert('El JSON no es v√°lido.');
        return;
      }
      const info = {
        tema: tema,
        font: 'notebooklm',
        any: getCurrentYear(),
        dades: jsonData
      };
      // Mostrar confirmaci√≥n
      const msg =
        '¬øGuardar en la base de datos?\n' +
        'Tema: ' + info.tema + '\n' +
        'Font: ' + info.font + '\n' +
        'Any: ' + info.any + '\n' +
        'Dades: ' + JSON.stringify(info.dades, null, 2).slice(0, 400) + (JSON.stringify(info.dades).length > 400 ? '\n... (truncat)' : '');
      if (confirm(msg)) {
        send_question_toDB(info);
      } else {
        status.textContent = '‚ùå Cancel¬∑lat';
      }

    // Stub para enviar a la base de datos
    function send_question_toDB(info) {
      // Leer configuraci√≥n de la API desde assets/API_config.json
      fetch('assets/API_config.json')
        .then(r => r.json())
        .then(config => {
          const API_URL = config.BASE_URL.replace(/\/?$/, '') + '/preguntas-notelm';
          const API_KEY = config.API_KEY;
          // Recorrer info.dades.quiz si existe y es array
          if (info && info.dades && Array.isArray(info.dades.quiz)) {
            let total = info.dades.quiz.length;
            let guardadas = 0, fallidas = 0;
            status.textContent = `‚è≥ Guardant ${total} preguntes...`;
            info.dades.quiz.forEach((q, idx) => {
              // Construir objeto a guardar
              const data = {
                tema: info.tema,
                font: info.font,
                any: info.any,
                ...q
              };
              fetch(API_URL, {
                method: 'POST',
                headers: {
                  'content-type': 'application/json',
                  'x-apikey': API_KEY,
                  'cache-control': 'no-cache'
                },
                body: JSON.stringify(data)
              })
              .then(resp => {
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                return resp.json();
              })
              .then(response => {
                guardadas++;
                status.textContent = `‚úÖ Guardades: ${guardadas} / ${total}  ‚ùå Fallides: ${fallidas}`;
                // console.log('Guardada:', response);
              })
              .catch(err => {
                fallidas++;
                status.textContent = `‚úÖ Guardades: ${guardadas} / ${total}  ‚ùå Fallides: ${fallidas}`;
                // console.error('Error guardant:', err);
              });
            });
          } else {
            status.textContent = '‚ö†Ô∏è No s\'ha trobat cap array quiz en dades.';
          }
        })
        .catch(() => {
          status.textContent = '‚ùå Error carregant configuraci√≥ de la API.';
        });
    }
    });

    // Cargar temas al iniciar
    window.addEventListener('DOMContentLoaded', function() {
      fetch('assets/opos24_temes.json')
        .then(r => r.json())
        .then(temes => {
          const select = document.getElementById('temaSelect');
          select.innerHTML = '';
          temes.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.tema;
            opt.textContent = t.tema + ' - ' + t.titol;
            select.appendChild(opt);
          });
        })
        .catch(() => {
          const select = document.getElementById('temaSelect');
          select.innerHTML = '<option>Error carregant temes</option>';
        });
    });
    // Decodificador HTML (&quot;, &#39;, etc.)
    function htmlUnescape(str) {
      const temp = document.createElement("textarea");
      temp.innerHTML = str;
      return temp.value;
    }

    // Proceso completo de limpieza
    function unescapeAndParse(raw) {
      let step = raw;

      // 1Ô∏è‚É£ Quitar los dobles backslashes (\\n, \\u...)
      step = step.replace(/\\\\/g, "\\");

      // 2Ô∏è‚É£ Reemplazar secuencias \n reales por saltos de l√≠nea
      step = step.replace(/\\n/g, "\n");

      // 3Ô∏è‚É£ Decodificar unicode (\uXXXX)
      step = step.replace(/\\u([\dA-F]{4})/gi, (_, g) => String.fromCharCode(parseInt(g, 16)));

      // 4Ô∏è‚É£ Desescapar entidades HTML (&quot;, &#39;, etc.)
      step = htmlUnescape(step);

      // 5Ô∏è‚É£ Intentar parsear a JSON
      return JSON.parse(step);
    }

    const input = document.getElementById("input");
    const output = document.getElementById("output");
    const status = document.getElementById("status");
    const copyBtn = document.getElementById("copyBtn");

    // Generador simple de GUID
    function guid() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    const downloadBtn = document.getElementById('downloadBtn');
    document.getElementById("convertBtn").addEventListener("click", () => {
      try {
        const jsonData = unescapeAndParse(input.value);
        const isFlashcards = document.getElementById('flashcardsCheckbox').checked;
        
        if (isFlashcards && jsonData && Array.isArray(jsonData.flashcards)) {
          // Formato flashcards
          const temaSel = document.getElementById('temaSelect');
          const tema = temaSel ? temaSel.value : '';
          const result = {
            subjectId: tema,
            origin: 'notebooklm',
            flashcards: jsonData.flashcards.map(card => ({
              f: card.f,
              b: card.b
            }))
          };
          output.textContent = JSON.stringify(result, null, 2);
          status.textContent = `‚úÖ ${result.flashcards.length} flashcards convertidas.`;
        } else if (!isFlashcards && jsonData && Array.isArray(jsonData.quiz)) {
          // Formato quiz original
          const temaSel = document.getElementById('temaSelect');
          const tema = temaSel ? temaSel.value : '';
          const result = jsonData.quiz.map(q => ({
            guid: guid(),
            subjectId : tema,
            origin: 'notebooklm',
            type: 'test',
            difficulty: q.difficulty || '', //siempre sera nulo o vacio
            question: q.question,
            answerOptions: q.answerOptions.map(opt => ({
              text: opt.text,
              isCorrect: opt.isCorrect,
              rationale: opt.rationale || ''
            })),
            hint: q.hint || ''
          }));
          output.textContent = JSON.stringify(result, null, 2);
          status.textContent = `‚úÖ ${result.length} preguntas convertidas.`;
        } else {
          output.textContent = JSON.stringify(jsonData, null, 2);
          status.textContent = "‚úÖ Conversi√≥n completada correctamente.";
        }
      } catch (err) {
        output.textContent = "‚ùå Error al convertir: " + err.message;
        status.textContent = "";
      }
    });


    downloadBtn.addEventListener('click', function() {
      let data = output.textContent;
      if (!data) return;
      // Nombre: temaId-nombre_sin_caracteres_raros_trim30-test.json
      const temaSel = document.getElementById('temaSelect');
      const temaId = temaSel ? temaSel.value : 'tema';
      // Buscar nombre del tema
      let temaNombre = '';
      const opts = temaSel && temaSel.options;
      if (opts && opts.length) {
        const opt = opts[temaSel.selectedIndex];
        if (opt) {
          temaNombre = opt.textContent.replace(/^\w+\s*-\s*/, '');
        }
      }
      // Limpiar nombre: solo letras, numeros y guion_bajo
      temaNombre = temaNombre.normalize('NFD').replace(/[^\w\s-]/g, '').replace(/\s+/g, '_').toLowerCase();
      const MAX_LEN = 45;
      if (temaNombre.length > MAX_LEN) temaNombre = temaNombre.slice(0, MAX_LEN);
      const filename = `${temaId}-${temaNombre}-test.json`;
      // Descargar
      const blob = new Blob([data], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
    });

    copyBtn.addEventListener("click", () => {
      navigator.clipboard.writeText(output.textContent)
        .then(() => { status.textContent = "üìã JSON copiado al portapapeles."; })
        .catch(() => { status.textContent = "‚ö†Ô∏è No se pudo copiar."; });
    });
  </script>
</body>
</html>
