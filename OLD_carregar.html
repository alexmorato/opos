<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carregant preguntes...</title>
  <style>
    body { font-family: system-ui, sans-serif; background: #0b1020; color: #e7ecff; margin: 0; padding: 0; }
    .center { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
    .msg { font-size: 1.3rem; color: #6ae0a7; margin: 40px 0 18px 0; letter-spacing: 0.5px; }
    .logbox {
      width: 90vw; max-width: 700px; min-height: 320px; background: #141a2a; color: #e7ecff;
      border: 1.5px solid #27304a; border-radius: 10px; font-family: monospace; font-size: 1.05rem;
      padding: 18px 14px; margin-bottom: 30px; box-shadow: 0 4px 18px #0002; white-space: pre-wrap; overflow-y: auto;
    }
    .dots { font-size: 2.5rem; letter-spacing: 0.2em; color: #9fb0ff; min-height: 2.5rem; font-weight: bold; }
    #comencarBtn { width: 100%; max-width: 300px; background: linear-gradient(180deg,#2aebad,#21c08d); color: #032217; font-weight: bold; font-size: 1.1rem; padding: 14px 0; border-radius: 12px; border: none; cursor: pointer; margin-top: 30px; }
    #comencarBtn:disabled { opacity: 0.5; pointer-events: none; }
    #tornarBtn {
      display: none;
      margin-top: 10px;
      width: 100%;
      max-width: 200px;
      background: #27304a;
      color: #e7ecff;
      font-size: 1.05rem;
      padding: 10px 0;
      border-radius: 10px;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="center">
    <div class="msg">Carregant les preguntes<span id="dots"></span></div>
    <div class="logbox" id="logbox"></div>
  <button id="comencarBtn" disabled>començar!</button>
  <button id="tornarBtn">⬅️ Tornar</button>
  </div>
  <script>
    // --- Comprobación de usuario con bcryptjs ---
    async function checkUserAuth() {
      const user_guid = localStorage.getItem('user_guid');
      const user_pass = localStorage.getItem('user_pass');
      if (!user_guid || !user_pass) {
        window.location.href = 'index.html';
        return;
      }
      try {
        // Buscar usuario en users.json
        const usersData = await fetch('assets/users.json').then(r => r.json());
        if (!usersData || !Array.isArray(usersData.users)) throw new Error('No users');
        const user = usersData.users.find(u => u.guid === user_guid);
        if (!user) throw new Error('No user');
        // Esperar a que bcryptjs esté disponible
        function waitForBcrypt() {
          return new Promise(resolve => {
            (function check() {
              if (window.dcodeIO && window.dcodeIO.bcrypt) resolve(window.dcodeIO.bcrypt);
              else if (window.bcryptjs) resolve(window.bcryptjs);
              else if (window.bcrypt) resolve(window.bcrypt);
              else setTimeout(check, 50);
            })();
          });
        }
        const bcrypt = await waitForBcrypt();
        if (!bcrypt.compareSync(user_pass, user.password_hash)) throw new Error('Bad pass');
      } catch (e) {
        window.location.href = 'index.html';
      }
    }
    // Ejecutar al cargar
    document.addEventListener('DOMContentLoaded', checkUserAuth, {once:true});
    // Animació de 3 puntets
    var dots = '';
    var count = 0;
    setInterval(() => {
      count = (count + 1) % 4;
      dots = '.'.repeat(count);
      document.getElementById('dots').textContent = dots;
    }, 400);


    // Log helper
    const logbox = document.getElementById('logbox');
    function log(msg) {
      logbox.textContent += msg + '\n';
      logbox.scrollTop = logbox.scrollHeight;
    }


    // Obtener temas seleccionados
    let temas = [];
    try {
      temas = JSON.parse(localStorage.getItem('oposTest_temas') || '[]');
    } catch (e) { temas = []; }

    if (!temas.length) {
      log('No hi ha temes seleccionats.');
    } else {
      log('Temes seleccionats: ' + temas.join(', '));
      // Cargar manifest.json y buscar ficheros que empiecen por los temas seleccionados
      fetch('testfiles/manifest.json')
        .then(r => r.json())
        .then(manifest => {
          let files = Array.isArray(manifest) ? manifest : manifest.files;
          if (!Array.isArray(files)) {
            log('Manifest incorrecte.');
            return;
          }
          // Buscar ficheros que empiecen por algún tema
          let encontrados = [];
          temas.forEach(tema => {
            encontrados = encontrados.concat(files.filter(f => f.startsWith(tema)));
          });
          // Eliminar duplicados
          encontrados = [...new Set(encontrados)];
          if (!encontrados.length) {
            log('No s\'ha trobat cap fitxer per als temes seleccionats.');
            document.getElementById('comencarBtn').disabled = true;
            document.getElementById('tornarBtn').style.display = 'block';
            return;
          }
            log('Fitxers trobats: ' + encontrados.length);
          // Mostrar un botón por cada fichero encontrado (selección múltiple)
          const logbox = document.getElementById('logbox');
          const btnsDiv = document.createElement('div');
          btnsDiv.style.marginTop = '18px';
          let seleccionats = [];
          encontrados.forEach(fichero => {
            const btn = document.createElement('button');
            btn.textContent = fichero;
            btn.style.display = 'block';
            btn.style.width = '100%';
            btn.style.margin = '8px 0';
            btn.style.background = '#27304a';
            btn.style.color = '#e7ecff';
            btn.style.fontSize = '1.08rem';
            btn.style.border = '1px solid #2a3554';
            btn.style.borderRadius = '8px';
            btn.style.padding = '10px 0';
            btn.style.cursor = 'pointer';
            btn.onclick = function() {
              if (seleccionats.includes(fichero)) {
                // Deseleccionar
                seleccionats = seleccionats.filter(f => f !== fichero);
                btn.style.outline = '';
              } else {
                // Seleccionar
                seleccionats.push(fichero);
                btn.style.outline = '3px solid #6ae0a7';
              }
              // Guardar selección múltiple en localStorage
              localStorage.setItem('oposTest_fitxer', JSON.stringify(seleccionats));
              // Habilitar o deshabilitar el botón comenzar
              document.getElementById('comencarBtn').disabled = seleccionats.length === 0;
            };
            btnsDiv.appendChild(btn);
          });
          logbox.appendChild(btnsDiv);
          // Deshabilitar comenzar hasta que se seleccione al menos un fichero
          document.getElementById('comencarBtn').disabled = true;
        })
        .catch(() => {
          log('No s\'ha pogut carregar el manifest de fitxers.');
        });
    }

    // Acción del botón tornar
    document.getElementById('tornarBtn').onclick = function() {
      window.location.href = 'init.html';
    };

    document.getElementById('comencarBtn').onclick = function() {
      window.location.href = 'estudiar.html';
    };
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carregant preguntes...</title>
  <style>
    body { font-family: system-ui, sans-serif; background: #0b1020; color: #e7ecff; margin: 0; padding: 0; }
    .center {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .msg {
      font-size: 1.3rem;
      color: #6ae0a7;
      margin-bottom: 30px;
      letter-spacing: 0.5px;
    }
    .dots {
      font-size: 2.5rem;
      letter-spacing: 0.2em;
      color: #9fb0ff;
      min-height: 2.5rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="center">
    <div class="msg">Carregant les preguntes<span id="dots"></span></div>
  </div>
  <script>
    // Animació de 3 puntets
    let dots = '';
    let dots2 = '';
    let count = 0;
    setInterval(() => {
      count = (count + 1) % 4;
      dots = '.'.repeat(count);
      document.getElementById('dots').textContent = dots;
    }, 400);
  </script>
</body>
</html>
