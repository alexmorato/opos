<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Selecciona fitxers</title>
  <style>
    body { font-family: system-ui, sans-serif; background: #0b1020; color: #e7ecff; margin: 0; padding: 0; }
    .center { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
    .msg { font-size: 1.3rem; color: #6ae0a7; margin: 40px 0 18px 0; letter-spacing: 0.5px; }
    .logbox {
      width: 90vw; max-width: 700px; min-height: 320px; background: #141a2a; color: #e7ecff;
      border: 1.5px solid #27304a; border-radius: 10px; font-family: monospace; font-size: 1.05rem;
      padding: 18px 14px; margin-bottom: 30px; box-shadow: 0 4px 18px #0002; white-space: pre-wrap; overflow-y: auto;
    }
    #comencarBtn { width: 100%; max-width: 300px; background: linear-gradient(180deg,#2aebad,#21c08d); color: #032217; font-weight: bold; font-size: 1.1rem; padding: 14px 0; border-radius: 12px; border: none; cursor: pointer; margin-top: 30px; }
    #comencarBtn:disabled { opacity: 0.5; pointer-events: none; }
    #tornarBtn {
  display: block;
      margin-top: 10px;
      width: 100%;
      max-width: 200px;
      background: #27304a;
      color: #e7ecff;
      font-size: 1.05rem;
      padding: 10px 0;
      border-radius: 10px;
      border: none;
      cursor: pointer;
    }
    .titulo {
      text-align: center;
      color: #6ae0a7;
      font-size: 2.2rem;
      font-weight: bold;
      margin-top: 32px;
      margin-bottom: 10px;
      letter-spacing: 0.5px;
    }
    /* mini-btn styles moved to the correct place above. */
  </style>
</head>
<body>
  <div class="center">
    <div class="titulo">Selecciona fitxers</div>
    <div class="logbox" id="logbox"></div>
    <button id="comencarBtn" disabled>començar!</button>
    <button id="tornarBtn">⬅️ Tornar</button>
  </div>
  <script>
    // --- Comprobación de usuario con bcryptjs ---
    async function checkUserAuth() {
      const user_guid = localStorage.getItem('user_guid');
      const user_pass = localStorage.getItem('user_pass');
      if (!user_guid || !user_pass) {
        window.location.href = 'index.html';
        return;
      }
      try {
        // Buscar usuario en users.json
        const usersData = await fetch('assets/users.json').then(r => r.json());
        if (!usersData || !Array.isArray(usersData.users)) throw new Error('No users');
        const user = usersData.users.find(u => u.guid === user_guid);
        if (!user) throw new Error('No user');
        // Esperar a que bcryptjs esté disponible
        function waitForBcrypt() {
          return new Promise(resolve => {
            (function check() {
              if (window.dcodeIO && window.dcodeIO.bcrypt) resolve(window.dcodeIO.bcrypt);
              else if (window.bcryptjs) resolve(window.bcryptjs);
              else if (window.bcrypt) resolve(window.bcrypt);
              else setTimeout(check, 50);
            })();
          });
        }
        const bcrypt = await waitForBcrypt();
        if (!bcrypt.compareSync(user_pass, user.password_hash)) throw new Error('Bad pass');
      } catch (e) {
        window.location.href = 'index.html';
      }
    }
    // Ejecutar al cargar
    document.addEventListener('DOMContentLoaded', checkUserAuth, {once:true});
    // (Animació de puntets eliminada)

    // Log helper
    const logbox = document.getElementById('logbox');
    function log(msg) {
      logbox.textContent += msg + '\n';
      logbox.scrollTop = logbox.scrollHeight;
    }

    // Obtener temas seleccionats
    let temas = [];
    try {
      temas = JSON.parse(localStorage.getItem('oposTest_temas') || '[]');
    } catch (e) { temas = []; }

    if (!temas.length) {
      log('No hi ha temes seleccionats.');
    } else {
      log('Temes seleccionats: ' + temas.join(', '));
      // Mostrar tipo de test seleccionado
      let tipoTestLog = null;
      try {
        tipoTestLog = localStorage.getItem('oposTest_tipoPregunta');
        if (tipoTestLog && typeof tipoTestLog === 'string') {
          tipoTestLog = tipoTestLog.replace(/^"|"$/g, '');
        }
      } catch (e) { tipoTestLog = null; }
      log('Tipus de test seleccionat: ' + (tipoTestLog ? tipoTestLog : 'Tots'));
      // Cargar manifest.json y buscar ficheros que empiecen por los temas seleccionats
      fetch('testfiles/manifest.json')
        .then(r => r.json())
        .then(manifest => {
          let files = Array.isArray(manifest) ? manifest : manifest.files;
          if (!Array.isArray(files)) {
            log('Manifest incorrecte.');
            return;
          }
          // Buscar ficheros que empiecen por algún tema
          let encontrados = [];
          temas.forEach(tema => {
            encontrados = encontrados.concat(files.filter(f => f.startsWith(tema)));
          });
          // Eliminar duplicados
          encontrados = [...new Set(encontrados)];
          if (!encontrados.length) {
            log('No s\'ha trobat cap fitxer per als temes seleccionats.');
            document.getElementById('comencarBtn').disabled = true;
            document.getElementById('tornarBtn').style.display = 'block';
            return;
          }
          log('Fitxers trobats: ' + encontrados.length);
          // Botones seleccionar/deseleccionar todos
          const controlsDiv = document.createElement('div');
          controlsDiv.style.display = 'flex';
          controlsDiv.style.gap = '10px';
          controlsDiv.style.margin = '8px 0 0 0';
          controlsDiv.style.justifyContent = 'flex-end';
            const btnSelectAll = document.createElement('button');
            btnSelectAll.textContent = 'Seleccionar tots';
            btnSelectAll.className = 'mini-btn mini-btn-green';
            const btnDeselectAll = document.createElement('button');
            btnDeselectAll.textContent = 'Deseleccionar';
            btnDeselectAll.className = 'mini-btn mini-btn-gray';
          controlsDiv.appendChild(btnSelectAll);
          controlsDiv.appendChild(btnDeselectAll);
          logbox.appendChild(controlsDiv);

          // Mostrar un botón por cada fichero encontrado (selección múltiple)
          const btnsDiv = document.createElement('div');
          btnsDiv.style.marginTop = '18px';
          let seleccionats = [];
          const btnMap = {};
          encontrados.forEach(fichero => {
            const btn = document.createElement('button');
            btn.textContent = fichero;
            btn.style.display = 'block';
            btn.style.width = '100%';
            btn.style.margin = '8px 0';
            btn.style.background = '#27304a';
            btn.style.color = '#e7ecff';
            btn.style.fontSize = '1.08rem';
            btn.style.border = '1px solid #2a3554';
            btn.style.borderRadius = '8px';
            btn.style.padding = '10px 0';
            btn.style.cursor = 'pointer';
            btn.onclick = function() {
              if (seleccionats.includes(fichero)) {
                // Deseleccionar
                seleccionats = seleccionats.filter(f => f !== fichero);
                btn.style.outline = '';
              } else {
                // Seleccionar
                seleccionats.push(fichero);
                btn.style.outline = '3px solid #6ae0a7';
              }
              localStorage.setItem('oposTest_fitxer', JSON.stringify(seleccionats));
              document.getElementById('comencarBtn').disabled = seleccionats.length === 0;
            };
            btnsDiv.appendChild(btn);
            btnMap[fichero] = btn;
          });
          logbox.appendChild(btnsDiv);
          // Funcionalidad seleccionar todos
          btnSelectAll.onclick = function() {
            seleccionats = [...encontrados];
            encontrados.forEach(fichero => {
              btnMap[fichero].style.outline = '3px solid #6ae0a7';
            });
            localStorage.setItem('oposTest_fitxer', JSON.stringify(seleccionats));
            document.getElementById('comencarBtn').disabled = seleccionats.length === 0;
          };
          // Funcionalidad deseleccionar todos
          btnDeselectAll.onclick = function() {
            seleccionats = [];
            encontrados.forEach(fichero => {
              btnMap[fichero].style.outline = '';
            });
            localStorage.setItem('oposTest_fitxer', JSON.stringify(seleccionats));
            document.getElementById('comencarBtn').disabled = true;
          };
          // Deshabilitar comenzar hasta que se seleccione al menos un fichero
          document.getElementById('comencarBtn').disabled = true;
        })
        .catch(() => {
          log('No s\'ha pogut carregar el manifest de fitxers.');
        });
    }

    // Acción del botón tornar
    document.getElementById('tornarBtn').onclick = function() {
      window.location.href = 'init.html';
    };

    document.getElementById('comencarBtn').onclick = function() {
      // Leer ficheros seleccionados y concatenar preguntas
      let fitxers = [];
      try {
        fitxers = JSON.parse(localStorage.getItem('oposTest_fitxer') || '[]');
      } catch (e) { fitxers = []; }
      if (!Array.isArray(fitxers) || !fitxers.length) {
        alert('No hi ha fitxers seleccionats.');
        return;
      }
      let preguntesTot = [];
      let filesLoaded = 0;
      // Leer tipoPregunta del localStorage
      let tipoPregunta = null;
      try {
        tipoPregunta = localStorage.getItem('oposTest_tipoPregunta');
        if (tipoPregunta && typeof tipoPregunta === 'string') {
          // Eliminar comillas extra si las hay
          tipoPregunta = tipoPregunta.replace(/^"|"$/g, '');
        }
        if (tipoPregunta === '' || tipoPregunta === null || tipoPregunta === undefined) tipoPregunta = null;
      } catch (e) { tipoPregunta = null; }

      fitxers.forEach(fitxer => {
        fetch('testfiles/' + fitxer)
          .then(r => r.json())
          .then(data => {
            let preguntas = [];
            if (Array.isArray(data)) {
              preguntas = data;
            } else if (Array.isArray(data.preguntes)) {
              preguntas = data.preguntes;
            }
            // Filtrar por tipoPregunta si está definido y no nulo
            if (tipoPregunta) {
              preguntas = preguntas.filter(q => (q.type || '') === tipoPregunta);
            }
            preguntesTot = preguntesTot.concat(preguntas);
            filesLoaded++;
            if (filesLoaded === fitxers.length) {
              // Guardar preguntas concatenadas y navegar
              localStorage.setItem('oposTest_preguntes', JSON.stringify(preguntesTot));
              window.location.href = 'estudiar.html';
            }
          })
          .catch(() => {
            filesLoaded++;
            if (filesLoaded === fitxers.length) {
              localStorage.setItem('oposTest_preguntes', JSON.stringify(preguntesTot));
              window.location.href = 'estudiar.html';
            }
          });
      });
    };
  </script>
</body>
</html>
